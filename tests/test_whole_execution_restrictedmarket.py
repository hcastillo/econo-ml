# -*- coding: utf-8 -*-

import unittest
import interbank
import interbank_lenderchange


class WholeExecution(unittest.TestCase):
    N = 50
    T = 50
    T_LONG = 1000

    maxDiff = None

    ALGORITHM = interbank_lenderchange.RestrictedMarket
    P = 0.5

    SEED = 39393

    RESULTS_TO_COMPARE = '{"bad_debt":{"0":0.0,"1":0.0,"2":7.1798000187,"3":0.0,"4":0.0,"5":4.7708536599,"6":16.6849590595,"7":0.0,"8":14.4450690314,"9":0.0,"10":25.7983046676,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0,"16":16.6812020421,"17":0.0,"18":0.0,"19":0.0,"20":9.3040542375,"21":23.0887127902,"22":0.0,"23":0.0,"24":0.0,"25":15.4185588877,"26":0.0,"27":0.0,"28":0.0,"29":13.4241169278,"30":0.0,"31":0.0,"32":0.0,"33":4.0588260713,"34":0.0,"35":0.0,"36":0.0,"37":2.9486603365,"38":0.0,"39":23.2990991449,"40":30.8698435443,"41":0.0,"42":0.0,"43":0.0,"44":8.1421068768,"45":0.0,"46":38.7684810532,"47":0.0,"48":0.0,"49":11.3254671116},"liquidity":{"0":1720.5021386348,"1":2217.6744138474,"2":2942.3163013001,"3":3191.9830336496,"4":3871.4673103989,"5":3805.5848238273,"6":3734.2680037361,"7":4123.0915884732,"8":4459.725380787,"9":5008.5306206688,"10":5177.9734048741,"11":5489.3888476504,"12":5647.6480794873,"13":6130.9657679973,"14":6307.9815199548,"15":6316.4179913401,"16":6637.7616382656,"17":6779.176110204,"18":7231.055468342,"19":6953.8564124588,"20":8009.3806567147,"21":7874.8141520992,"22":8332.0795659054,"23":9054.6006521864,"24":8785.3630475826,"25":9476.4678674454,"26":10069.9105381268,"27":10713.836213684,"28":10675.4513152221,"29":10663.3178637095,"30":10183.6653637464,"31":10950.0201841681,"32":10609.487719179,"33":9933.4770178145,"34":9655.8892468974,"35":9974.2767773152,"36":11065.0750509955,"37":10669.4447373884,"38":9706.5158253191,"39":9006.5858567689,"40":9744.2053210843,"41":11256.6192283653,"42":11802.3758801169,"43":11638.5310232503,"44":12612.5018533968,"45":12985.5396815056,"46":14027.0528767844,"47":15762.7432444069,"48":15716.5592993972,"49":16517.4403767143},"interest_rate":{"0":null,"1":0.02,"2":0.02,"3":null,"4":null,"5":0.0007873039,"6":0.0025214926,"7":null,"8":0.0009350821,"9":0.0026353734,"10":0.0039754854,"11":0.0192273367,"12":null,"13":null,"14":null,"15":0.0036174259,"16":0.02,"17":null,"18":0.0155762422,"19":null,"20":0.02,"21":0.0187488426,"22":0.0102530478,"23":null,"24":null,"25":1.3266444491,"26":0.0070602441,"27":null,"28":null,"29":0.0234820119,"30":0.02,"31":null,"32":null,"33":0.6504531118,"34":0.02,"35":0.0002386583,"36":0.02,"37":0.02,"38":null,"39":3.8830547675,"40":0.1859737857,"41":null,"42":null,"43":null,"44":0.0041124337,"45":0.02,"46":0.02,"47":null,"48":0.02,"49":0.0155900103},"asset_i":{"0":0.0,"1":2.3462648844,"2":2.5056169199,"3":0.0,"4":0.0,"5":3.0787596508,"6":3.0799304402,"7":0.0,"8":3.0885744818,"9":3.5173676323,"10":2.748182641,"11":3.8382371003,"12":0.0,"13":0.0,"14":0.0,"15":3.6999332029,"16":3.5642775094,"17":0.0,"18":4.1398811999,"19":0.0,"20":4.3086400975,"21":4.476325849,"22":4.0410248248,"23":0.0,"24":0.0,"25":5.432843367,"26":3.9452922888,"27":0.0,"28":0.0,"29":5.4263597319,"30":4.6537484976,"31":0.0,"32":0.0,"33":4.3419720122,"34":5.681750261,"35":4.7848909794,"36":5.1031755318,"37":5.313278413,"38":0.0,"39":3.883454261,"40":4.6869936827,"41":0.0,"42":0.0,"43":0.0,"44":5.3211058698,"45":5.5507971448,"46":6.0213685242,"47":0.0,"48":5.9300103515,"49":6.8939544042},"asset_j":{"0":null,"1":3.8758432325,"2":4.1408573118,"3":null,"4":null,"5":5.0017840503,"6":4.9692121132,"7":null,"8":5.1482150236,"9":5.3327554142,"10":5.5597113985,"11":5.7368359802,"12":null,"13":null,"14":null,"15":6.2611563747,"16":6.2088239988,"17":null,"18":6.5068232053,"19":null,"20":6.5971949441,"21":7.1210752046,"22":7.0723121669,"23":null,"24":null,"25":7.5699539915,"26":7.8903379973,"27":null,"28":null,"29":8.4988514521,"30":8.4736380192,"31":null,"32":null,"33":8.4324309359,"34":8.1625117303,"35":7.9899611566,"36":8.1641549116,"37":8.6512956724,"38":null,"39":7.9976588726,"40":7.6935506874,"41":null,"42":null,"43":null,"44":8.9777936171,"45":9.4735214729,"46":9.6824272662,"47":null,"48":11.0594430365,"49":11.0594057641},"equity":{"0":null,"1":608.0511823518,"2":468.8496530795,"3":null,"4":null,"5":531.2747885121,"6":576.3020565028,"7":null,"8":651.5450455092,"9":599.6696235454,"10":663.6020296485,"11":508.0828542715,"12":null,"13":null,"14":null,"15":597.0430211358,"16":570.0956799763,"17":null,"18":573.427190174,"19":null,"20":629.619961267,"21":595.2779550278,"22":531.8817573394,"23":null,"24":null,"25":613.6724944748,"26":491.90206057,"27":null,"28":null,"29":540.1400645223,"30":596.7629060603,"31":null,"32":null,"33":535.6322224263,"34":528.4059705699,"35":555.8893663305,"36":567.1952088775,"37":543.5066370448,"38":null,"39":490.6416386107,"40":531.1145521201,"41":null,"42":null,"43":null,"44":543.9357064436,"45":550.3913676316,"46":552.631975611,"47":null,"48":557.5685233463,"49":445.439395645},"equity_borrowers":{"0":null,"1":15.0,"2":44.8834675476,"3":null,"4":null,"5":15.0,"6":15.0,"7":null,"8":15.0,"9":15.0,"10":29.9931425428,"11":15.0,"12":null,"13":null,"14":null,"15":15.0,"16":4.8136659755,"17":null,"18":15.0,"19":null,"20":-1.9138337907,"21":45.0,"22":14.8604427529,"23":null,"24":null,"25":5.595155847,"26":15.0,"27":null,"28":null,"29":15.0,"30":15.0,"31":null,"32":null,"33":7.6939868433,"34":15.0,"35":15.0,"36":15.0,"37":24.9933947433,"38":null,"39":2.3174063895,"40":24.778487019,"41":null,"42":null,"43":null,"44":15.0,"45":15.0,"46":7.0036819973,"47":null,"48":15.0,"49":15.0},"bankruptcies":{"0":6,"1":10,"2":10,"3":4,"4":8,"5":10,"6":11,"7":9,"8":5,"9":2,"10":4,"11":6,"12":6,"13":9,"14":6,"15":2,"16":5,"17":3,"18":3,"19":6,"20":5,"21":3,"22":4,"23":3,"24":7,"25":4,"26":5,"27":5,"28":2,"29":3,"30":0,"31":3,"32":2,"33":3,"34":2,"35":2,"36":2,"37":4,"38":3,"39":8,"40":6,"41":4,"42":4,"43":2,"44":4,"45":2,"46":6,"47":6,"48":2,"49":5},"potential_credit_channels":{"0":20,"1":20,"2":20,"3":20,"4":20,"5":20,"6":20,"7":20,"8":20,"9":20,"10":20,"11":20,"12":20,"13":20,"14":20,"15":20,"16":20,"17":20,"18":20,"19":20,"20":20,"21":20,"22":20,"23":20,"24":20,"25":20,"26":20,"27":20,"28":20,"29":20,"30":20,"31":20,"32":20,"33":20,"34":20,"35":20,"36":20,"37":20,"38":20,"39":20,"40":20,"41":20,"42":20,"43":20,"44":20,"45":20,"46":20,"47":20,"48":20,"49":20},"prob_change_lender":{"0":0.0,"1":0.0,"2":0.0,"3":0.0,"4":0.0,"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.0,"10":0.0,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0,"16":0.0,"17":0.0,"18":0.0,"19":0.0,"20":0.0,"21":0.0,"22":0.0,"23":0.0,"24":0.0,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":0.0,"30":0.0,"31":0.0,"32":0.0,"33":0.0,"34":0.0,"35":0.0,"36":0.0,"37":0.0,"38":0.0,"39":0.0,"40":0.0,"41":0.0,"42":0.0,"43":0.0,"44":0.0,"45":0.0,"46":0.0,"47":0.0,"48":0.0,"49":0.0},"best_lender":{"0":7,"1":7,"2":7,"3":7,"4":7,"5":7,"6":7,"7":7,"8":7,"9":7,"10":7,"11":7,"12":7,"13":7,"14":7,"15":7,"16":7,"17":7,"18":7,"19":7,"20":7,"21":7,"22":7,"23":7,"24":7,"25":7,"26":7,"27":7,"28":7,"29":7,"30":7,"31":7,"32":7,"33":7,"34":7,"35":7,"36":7,"37":7,"38":7,"39":7,"40":7,"41":7,"42":7,"43":7,"44":7,"45":7,"46":7,"47":7,"48":7,"49":7},"potential_lenders":{"0":23,"1":23,"2":27,"3":26,"4":28,"5":21,"6":24,"7":24,"8":30,"9":23,"10":34,"11":25,"12":23,"13":20,"14":28,"15":30,"16":25,"17":29,"18":29,"19":24,"20":28,"21":25,"22":32,"23":25,"24":24,"25":27,"26":22,"27":27,"28":26,"29":20,"30":32,"31":28,"32":29,"33":25,"34":26,"35":30,"36":29,"37":26,"38":23,"39":24,"40":23,"41":28,"42":27,"43":31,"44":25,"45":25,"46":25,"47":27,"48":22,"49":22},"potential_borrowers":{"0":27,"1":27,"2":23,"3":24,"4":22,"5":29,"6":26,"7":26,"8":20,"9":27,"10":16,"11":25,"12":27,"13":30,"14":22,"15":20,"16":25,"17":21,"18":21,"19":26,"20":22,"21":25,"22":18,"23":25,"24":26,"25":23,"26":28,"27":23,"28":24,"29":30,"30":18,"31":22,"32":21,"33":25,"34":24,"35":20,"36":21,"37":24,"38":27,"39":26,"40":27,"41":22,"42":23,"43":19,"44":25,"45":25,"46":25,"47":23,"48":28,"49":28},"policy":{"0":1.0,"1":1.0,"2":1.0,"3":1.0,"4":1.0,"5":1.0,"6":1.0,"7":1.0,"8":1.0,"9":1.0,"10":1.0,"11":1.0,"12":1.0,"13":1.0,"14":1.0,"15":1.0,"16":1.0,"17":1.0,"18":1.0,"19":1.0,"20":1.0,"21":1.0,"22":1.0,"23":1.0,"24":1.0,"25":1.0,"26":1.0,"27":1.0,"28":1.0,"29":1.0,"30":1.0,"31":1.0,"32":1.0,"33":1.0,"34":1.0,"35":1.0,"36":1.0,"37":1.0,"38":1.0,"39":1.0,"40":1.0,"41":1.0,"42":1.0,"43":1.0,"44":1.0,"45":1.0,"46":1.0,"47":1.0,"48":1.0,"49":1.0},"fitness":{"0":0.0,"1":0.2887606899,"2":0.2256378634,"3":0.2122903575,"4":0.1668770046,"5":0.1198398141,"6":0.1169624026,"7":0.1369906925,"8":0.0911608374,"9":0.0875613335,"10":0.0767360434,"11":0.0868664484,"12":0.077671635,"13":0.0825867447,"14":0.1034846171,"15":0.0996175604,"16":0.203498841,"17":0.2121083392,"18":0.1801457642,"19":0.123311712,"20":0.1388272238,"21":0.1792507832,"22":0.1832677791,"23":0.2161106625,"24":0.2272276783,"25":0.1657361003,"26":0.1231775074,"27":0.1111499807,"28":0.157066013,"29":0.1587905667,"30":0.1394859613,"31":0.1445016565,"32":0.1998714467,"33":0.2391414855,"34":0.2347392994,"35":0.2161833799,"36":0.2332990027,"37":0.1992643967,"38":0.1618557929,"39":0.1949585877,"40":0.1899505965,"41":0.1738410089,"42":0.1838177738,"43":0.1740510625,"44":0.2073679185,"45":0.1539057486,"46":0.1578126372,"47":0.1439352118,"48":0.1508132967,"49":0.1306817039},"best_lender_clients":{"0":2,"1":2,"2":2,"3":2,"4":2,"5":2,"6":2,"7":2,"8":2,"9":2,"10":2,"11":2,"12":2,"13":2,"14":2,"15":2,"16":2,"17":2,"18":2,"19":2,"20":2,"21":2,"22":2,"23":2,"24":2,"25":2,"26":2,"27":2,"28":2,"29":2,"30":2,"31":2,"32":2,"33":2,"34":2,"35":2,"36":2,"37":2,"38":2,"39":2,"40":2,"41":2,"42":2,"43":2,"44":2,"45":2,"46":2,"47":2,"48":2,"49":2},"rationing":{"0":23.3619380212,"1":50.9832309389,"2":100.4885000642,"3":1.8857640953,"4":18.33103528,"5":63.643163749,"6":47.5937442177,"7":115.9631250149,"8":5.8429581169,"9":27.8330994631,"10":0.0,"11":52.8447818127,"12":53.8815433077,"13":65.6204522942,"14":45.5703230894,"15":23.8954474677,"16":28.8246624395,"17":8.2069713151,"18":36.670855899,"19":44.8549914231,"20":8.3425802679,"21":21.9992657556,"22":38.3000548114,"23":21.7211519854,"24":0.0,"25":8.1462241226,"26":42.7463177897,"27":65.9628455022,"28":7.9220087937,"29":36.0307976352,"30":0.0,"31":41.0099962404,"32":16.0687214443,"33":29.6923227503,"34":26.828945166,"35":21.1344450852,"36":10.4328334914,"37":17.6278265261,"38":0.0,"39":37.5402647363,"40":20.0539863855,"41":17.119042535,"42":3.9810603055,"43":3.1469626618,"44":22.285587823,"45":16.0294015094,"46":8.146840131,"47":21.7239165669,"48":3.951867337,"49":50.7739648669},"leverage":{"0":null,"1":0.3884415079,"2":0.4255775724,"3":null,"4":null,"5":0.3180569107,"6":1.112330604,"7":null,"8":0.9630046021,"9":0.1734721191,"10":0.8600707217,"11":0.320359112,"12":null,"13":null,"14":null,"15":1.1752808116,"16":3.4653842055,"17":null,"18":0.6991762898,"19":null,"20":-4.8614745349,"21":0.7878215255,"22":1.0324127347,"23":null,"24":null,"25":2.755697841,"26":1.0832923426,"27":null,"28":null,"29":0.8949411285,"30":0.5213498456,"31":null,"32":null,"33":0.5275322344,"34":0.9850767888,"35":0.974857943,"36":0.8189553633,"37":0.6359131035,"38":null,"39":10.0539548223,"40":1.2997987689,"41":null,"42":null,"43":null,"44":0.5428071251,"45":0.3425629063,"46":-1.5330258557,"47":null,"48":0.1506421188,"49":0.7550311408},"loans":{"0":null,"1":5.8266226184,"2":6.3824488222,"3":null,"4":null,"5":4.7708536599,"6":16.6849590595,"7":null,"8":14.4450690314,"9":2.6020817861,"10":12.8991523338,"11":4.8053866799,"12":null,"13":null,"14":null,"15":17.6292121744,"16":16.6812020421,"17":null,"18":10.487644347,"19":null,"20":9.3040542375,"21":11.8173228823,"22":15.3421103421,"23":null,"24":null,"25":15.4185588877,"26":16.2493851392,"27":null,"28":null,"29":13.4241169278,"30":7.8202476838,"31":null,"32":null,"33":4.0588260713,"34":14.7761518315,"35":14.6228691453,"36":12.2843304502,"37":6.8470232768,"38":null,"39":23.2990991449,"40":15.4349217721,"41":null,"42":null,"43":null,"44":8.1421068768,"45":5.1384435939,"46":19.3842405266,"47":null,"48":2.2596317816,"49":11.3254671116},"reserves":{"0":142.054084939,"1":151.9932634304,"2":166.9030722246,"3":171.8235313436,"4":185.747509285,"5":184.6083460134,"6":183.4076337572,"7":191.171239329,"8":198.457513265,"9":209.6487733269,"10":213.5769654788,"11":219.5126550628,"12":222.5795590592,"13":232.8451067148,"14":236.405466183,"15":236.803625579,"16":243.5271254815,"17":246.4131351129,"18":255.562022688,"19":249.8866305029,"20":271.5384453579,"21":269.2435139466,"22":278.3855825092,"23":293.1507876095,"24":287.6529277543,"25":301.8457733604,"26":314.1503081775,"27":327.3830438981,"28":326.5996786234,"29":326.5033519466,"30":316.7915749894,"31":332.4614417398,"32":325.395753852,"33":311.593118627,"34":306.0522273451,"35":312.4304167311,"36":334.8868667959,"37":326.7771790612,"38":306.9132052837,"39":293.3139377444,"40":308.9655622322,"41":339.8301369704,"42":349.7584325802,"43":346.3706629331,"44":366.4137840969,"45":373.8855295518,"46":395.4883976235,"47":430.9805482237,"48":430.012850511,"49":446.6067711938},"deposits":{"0":7102.7042469491,"1":7599.663171519,"2":8345.1536112312,"3":8591.17656718,"4":9287.3754642506,"5":9230.417300672,"6":9170.3816878586,"7":9558.5619664508,"8":9922.87566325,"9":10482.4386663463,"10":10678.8482739408,"11":10975.6327531376,"12":11128.9779529583,"13":11642.2553357421,"14":11820.2733091511,"15":11840.18127895,"16":12176.3562740769,"17":12320.6567556467,"18":12778.1011343993,"19":12494.3315251447,"20":13576.9222678945,"21":13462.1756973287,"22":13919.2791254601,"23":14657.5393804757,"24":14382.646387714,"25":15092.2886680203,"26":15707.5154088767,"27":16369.1521949073,"28":16329.9839311706,"29":16325.1675973307,"30":15839.578749472,"31":16623.0720869924,"32":16269.7876926011,"33":15579.6559313513,"34":15302.6113672546,"35":15621.5208365563,"36":16744.3433397964,"37":16338.8589530621,"38":15345.6602641841,"39":14665.6968872216,"40":15448.2781116099,"41":16991.5068485207,"42":17487.9216290105,"43":17318.5331466573,"44":18320.6892048444,"45":18694.2764775924,"46":19774.4198811746,"47":21549.0274111874,"48":21500.6425255515,"49":22330.3385596911},"active_lenders":{"0":0,"1":1,"2":3,"3":0,"4":0,"5":1,"6":1,"7":0,"8":1,"9":1,"10":2,"11":1,"12":0,"13":0,"14":0,"15":1,"16":1,"17":0,"18":1,"19":0,"20":1,"21":3,"22":1,"23":0,"24":0,"25":1,"26":1,"27":0,"28":0,"29":1,"30":1,"31":0,"32":0,"33":1,"34":1,"35":1,"36":1,"37":2,"38":0,"39":1,"40":2,"41":0,"42":0,"43":0,"44":1,"45":1,"46":2,"47":0,"48":1,"49":1},"active_borrowers":{"0":0,"1":1,"2":3,"3":0,"4":0,"5":1,"6":1,"7":0,"8":1,"9":1,"10":2,"11":1,"12":0,"13":0,"14":0,"15":1,"16":1,"17":0,"18":1,"19":0,"20":1,"21":3,"22":1,"23":0,"24":0,"25":1,"26":1,"27":0,"28":0,"29":1,"30":1,"31":0,"32":0,"33":1,"34":1,"35":1,"36":1,"37":2,"38":0,"39":1,"40":2,"41":0,"42":0,"43":0,"44":1,"45":1,"46":2,"47":0,"48":1,"49":1},"prob_bankruptcy":{"0":0.0,"1":0.0,"2":0.0025896101,"3":0.0,"4":0.0,"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.0,"10":0.0002285819,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0,"16":0.0,"17":0.0,"18":0.0,"19":0.0,"20":0.0,"21":0.0,"22":0.0,"23":0.0,"24":0.0,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":0.0,"30":0.0,"31":0.0,"32":0.0,"33":0.0,"34":0.0,"35":0.0,"36":0.0,"37":0.1668868419,"38":0.0,"39":0.0,"40":0.1740504327,"41":0.0,"42":0.0,"43":0.0,"44":0.0,"45":0.0,"46":0.7665439334,"47":0.0,"48":0.0,"49":0.0},"num_banks":{"0":50,"1":50,"2":50,"3":50,"4":50,"5":50,"6":50,"7":50,"8":50,"9":50,"10":50,"11":50,"12":50,"13":50,"14":50,"15":50,"16":50,"17":50,"18":50,"19":50,"20":50,"21":50,"22":50,"23":50,"24":50,"25":50,"26":50,"27":50,"28":50,"29":50,"30":50,"31":50,"32":50,"33":50,"34":50,"35":50,"36":50,"37":50,"38":50,"39":50,"40":50,"41":50,"42":50,"43":50,"44":50,"45":50,"46":50,"47":50,"48":50,"49":50},"bankruptcy_rationed":{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0}}'

    def setUp(self):
        model = interbank.Model()
        model.config.lender_change = self.ALGORITHM()
        model.config.lender_change.set_parameter("p", self.P)
        model.configure(N=self.N, T=self.T)
        model.initialize(seed=self.SEED)
        model.simulate_full()
        self.generated_now_values = model.finish()
        ## self.results.to_dict() and save the json to self.RESULTS_TO_COMPARE
        ## also        json.dumps(separators=(',', ':'), obj=self.results.to_json())

        # we also create a gdt file with a whole execution:
        model.configure(T=self.T_LONG)
        model.statistics.define_output_format('gdt')
        model.initialize(seed=self.SEED, output_directory='tests',
                         export_datafile='test_whole_execution_restrictedmarket')
        model.simulate_full(interactive=True)
        model.finish()

    def test_values_after_execution(self):
        self.assertEqual(self.generated_now_values.to_json(), self.RESULTS_TO_COMPARE)


if __name__ == '__main__':
    unittest.main()
