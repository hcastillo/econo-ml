# -*- coding: utf-8 -*-

import unittest
import interbank
import interbank_lenderchange
import os


class WholeExecution(unittest.TestCase):
    N = 50
    T = 50
    T_LONG = 1000

    maxDiff = None

    ALGORITHM = interbank_lenderchange.RestrictedMarket
    P = 0.5

    SEED = 39393

    RESULTS_TO_COMPARE = '{"bad_debt":{"0":0.0,"1":0.0,"2":0.0,"3":7.4940279608,"4":0.0,"5":5.824194378,"6":18.091799913,"7":0.0,"8":14.4450690314,"9":0.0,"10":26.4782833836,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":17.6292121744,"16":0.0,"17":0.0,"18":0.0,"19":0.0,"20":0.0,"21":23.1056110603,"22":0.0,"23":0.0,"24":0.7232797011,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":4.5537508276,"30":7.8202476838,"31":0.0,"32":0.0,"33":0.0,"34":14.7761518315,"35":2.2346218974,"36":12.2843304502,"37":2.9486603365,"38":10.7041175286,"39":9.6892267766,"40":15.6555565038,"41":0.0,"42":0.0,"43":0.0,"44":8.1421068768,"45":5.1384435939,"46":27.8816201755,"47":0.0,"48":14.2718618192,"49":11.3254671116},"liquidity":{"0":1715.337018572,"1":2279.1199263776,"2":2935.1022721092,"3":3216.6319693025,"4":3890.1074090248,"5":3807.4829039324,"6":3653.0544681172,"7":3962.6000343279,"8":4261.241056813,"9":4849.434649682,"10":4911.4042741319,"11":5334.1539733536,"12":5412.6068129814,"13":5824.0734709905,"14":5905.3920269911,"15":5869.4852927327,"16":6102.8492617543,"17":6273.7674282072,"18":6866.3353090438,"19":6679.4512274042,"20":7709.099719795,"21":7211.1685585325,"22":7547.9114440135,"23":8128.3884230004,"24":7721.0579317499,"25":8596.1932210508,"26":9028.3827485578,"27":9331.1279447528,"28":9078.414280461,"29":8993.8934794981,"30":8545.7647179112,"31":9432.3927766327,"32":9427.371773802,"33":8942.0793040352,"34":8712.7360047594,"35":8943.7363783942,"36":10197.4501280297,"37":9776.1596445614,"38":8858.2706837483,"39":8314.5363127791,"40":9139.3934554249,"41":10568.779961323,"42":11064.9779283564,"43":11051.0847576118,"44":11766.1452313144,"45":12253.1831584463,"46":12848.4213219612,"47":14458.0326661225,"48":14306.040519021,"49":15329.9574594101},"interest_rate":{"0":0.0,"1":0.02,"2":0.02,"3":219.9663317472,"4":0.0,"5":255.9417068635,"6":248.5532522899,"7":0.0,"8":0.0935819513,"9":0.2639564125,"10":1.2899963037,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.3624233871,"16":0.0,"17":0.0,"18":0.02,"19":0.0,"20":0.0,"21":443.162028083,"22":0.0,"23":0.0,"24":200.098480739,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":155.0135548243,"30":20.8777842086,"31":0.0,"32":0.0,"33":0.0,"34":21.835178005,"35":90.741760841,"36":11.795828762,"37":10.0571065976,"38":0.3177292378,"39":1.8260308965,"40":0.7517817988,"41":0.0,"42":0.0,"43":0.0,"44":1.52331401,"45":29.8662165757,"46":31.7614498798,"47":0.0,"48":3133.0579272999,"49":35.1436280305},"asset_i":{"0":0.0,"1":2.3826545568,"2":2.5269485669,"3":2.4664698504,"4":2.7340844193,"5":3.0924094241,"6":3.1089425155,"7":2.8416079781,"8":3.1063994562,"9":3.5511274941,"10":2.6653199164,"11":3.8313120172,"12":3.2264175167,"13":3.3869882268,"14":2.9668274706,"15":3.5305901804,"16":3.3634548844,"17":3.8625413769,"18":4.1678818955,"19":3.7833688181,"20":4.3349659032,"21":4.3916691605,"22":3.8070594439,"23":4.6714430944,"24":4.3448041827,"25":5.0023431077,"26":3.5374452642,"27":4.7570397414,"28":4.3659036024,"29":4.4862288701,"30":4.0679031249,"31":4.2451972354,"32":4.1890346469,"33":4.210112039,"34":5.5047351115,"35":4.5125244384,"36":5.0723682696,"37":5.1165785805,"38":4.1714657484,"39":3.6927206978,"40":4.6482521976,"41":5.135866719,"42":3.9486843259,"43":5.1362687958,"44":5.1675787783,"45":5.4040721726,"46":5.5109687104,"47":6.097973738,"48":5.4303813841,"49":7.0043040268},"asset_j":{"0":0.0,"1":3.9495475721,"2":4.1791220399,"3":4.521966787,"4":4.7523734391,"5":5.1059058418,"6":5.08269234,"7":4.9958379233,"8":5.1570676055,"9":5.3246577225,"10":5.525868392,"11":5.6680098868,"12":5.8478113248,"13":5.9053533191,"14":6.0699385314,"15":6.1368140559,"16":6.1179468298,"17":6.2509108602,"18":6.3369298226,"19":6.562594523,"20":6.566209324,"21":7.0829639155,"22":6.9179274166,"23":7.1952083691,"24":7.4666248218,"25":7.2925787917,"26":7.6854975112,"27":7.9368851821,"28":8.069105896,"29":7.9510735096,"30":7.885280469,"31":7.6754816309,"32":8.1130347198,"33":8.1067063061,"34":7.910906996,"35":7.7764877433,"36":7.8316742933,"37":8.4622324474,"38":8.1279135105,"39":7.6639213286,"40":7.4182245862,"41":7.8542117443,"42":8.5228377707,"43":8.7950942342,"44":8.7916728094,"45":9.3728248658,"46":9.6268815763,"47":9.9420326842,"48":10.7273401503,"49":10.7050326703},"equity":{"0":710.6151281496,"1":707.4605752691,"2":691.6638779246,"3":665.7182884649,"4":654.6382615164,"5":627.9817918497,"6":628.5586445955,"7":625.7106789084,"8":634.0271848505,"9":648.0432816642,"10":635.5754665503,"11":634.055018223,"12":604.517350231,"13":648.7804389061,"14":645.5183853427,"15":640.8173354454,"16":642.2582200866,"17":642.5121993634,"18":645.1703291423,"19":620.6370141086,"20":611.2793156266,"21":621.0804192982,"22":608.9993018974,"23":623.3271450063,"24":621.3563916339,"25":604.8208260154,"26":601.4839466749,"27":621.6620806957,"28":616.824757766,"29":611.3493449057,"30":631.2127501504,"31":624.1906752626,"32":643.7756853669,"33":641.2700231748,"34":622.032407526,"35":643.8088123588,"36":647.2710289976,"37":622.4636125454,"38":614.1411543669,"39":610.8441936505,"40":592.6059667905,"41":579.9699773114,"42":596.4652219412,"43":596.4652219412,"44":631.1546276308,"45":612.0089053953,"46":599.2522044893,"47":601.5587762386,"48":591.2511105655,"49":560.5842250652},"equity_borrowers":{"0":0.0,"1":0.0,"2":3.6797573146,"3":0.0,"4":0.0,"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.0,"10":0.0,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0,"16":0.0,"17":0.0,"18":0.0,"19":0.0,"20":0.0,"21":0.0,"22":0.0,"23":0.0,"24":0.0,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":0.0,"30":0.0,"31":0.0,"32":0.0,"33":0.0,"34":0.0,"35":0.0,"36":0.0,"37":0.0,"38":0.0,"39":0.0,"40":0.0,"41":0.0,"42":0.0,"43":0.0,"44":0.0,"45":0.0,"46":0.0,"47":0.0,"48":0.0,"49":0.0},"bankruptcies":{"0":4,"1":9,"2":7,"3":2,"4":4,"5":6,"6":9,"7":6,"8":5,"9":3,"10":4,"11":5,"12":4,"13":9,"14":5,"15":2,"16":4,"17":3,"18":2,"19":4,"20":2,"21":4,"22":2,"23":4,"24":3,"25":4,"26":1,"27":4,"28":1,"29":4,"30":2,"31":1,"32":3,"33":2,"34":3,"35":5,"36":3,"37":1,"38":3,"39":6,"40":4,"41":2,"42":3,"43":1,"44":4,"45":2,"46":6,"47":3,"48":2,"49":3},"potential_credit_channels":{"0":20,"1":20,"2":20,"3":20,"4":20,"5":20,"6":20,"7":20,"8":20,"9":20,"10":20,"11":20,"12":20,"13":20,"14":20,"15":20,"16":20,"17":20,"18":20,"19":20,"20":20,"21":20,"22":20,"23":20,"24":20,"25":20,"26":20,"27":20,"28":20,"29":20,"30":20,"31":20,"32":20,"33":20,"34":20,"35":20,"36":20,"37":20,"38":20,"39":20,"40":20,"41":20,"42":20,"43":20,"44":20,"45":20,"46":20,"47":20,"48":20,"49":20},"prob_change_lender":{"0":0.0,"1":0.0,"2":0.0,"3":0.0,"4":0.0,"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.0,"10":0.0,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0,"16":0.0,"17":0.0,"18":0.0,"19":0.0,"20":0.0,"21":0.0,"22":0.0,"23":0.0,"24":0.0,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":0.0,"30":0.0,"31":0.0,"32":0.0,"33":0.0,"34":0.0,"35":0.0,"36":0.0,"37":0.0,"38":0.0,"39":0.0,"40":0.0,"41":0.0,"42":0.0,"43":0.0,"44":0.0,"45":0.0,"46":0.0,"47":0.0,"48":0.0,"49":0.0},"best_lender":{"0":7,"1":7,"2":7,"3":7,"4":7,"5":7,"6":7,"7":7,"8":7,"9":7,"10":7,"11":7,"12":7,"13":7,"14":7,"15":7,"16":7,"17":7,"18":7,"19":7,"20":7,"21":7,"22":7,"23":7,"24":7,"25":7,"26":7,"27":7,"28":7,"29":7,"30":7,"31":7,"32":7,"33":7,"34":7,"35":7,"36":7,"37":7,"38":7,"39":7,"40":7,"41":7,"42":7,"43":7,"44":7,"45":7,"46":7,"47":7,"48":7,"49":7},"policy":{"0":1.0,"1":1.0,"2":1.0,"3":1.0,"4":1.0,"5":1.0,"6":1.0,"7":1.0,"8":1.0,"9":1.0,"10":1.0,"11":1.0,"12":1.0,"13":1.0,"14":1.0,"15":1.0,"16":1.0,"17":1.0,"18":1.0,"19":1.0,"20":1.0,"21":1.0,"22":1.0,"23":1.0,"24":1.0,"25":1.0,"26":1.0,"27":1.0,"28":1.0,"29":1.0,"30":1.0,"31":1.0,"32":1.0,"33":1.0,"34":1.0,"35":1.0,"36":1.0,"37":1.0,"38":1.0,"39":1.0,"40":1.0,"41":1.0,"42":1.0,"43":1.0,"44":1.0,"45":1.0,"46":1.0,"47":1.0,"48":1.0,"49":1.0},"fitness":{"0":0.0,"1":0.2919578643,"2":0.238634159,"3":0.2166136835,"4":0.1729988826,"5":0.122239046,"6":0.1172986481,"7":0.1346891135,"8":0.0875579769,"9":0.0832754069,"10":0.0734551979,"11":0.0829463617,"12":0.0759421387,"13":0.0788607289,"14":0.0985863217,"15":0.0926283258,"16":0.1887949998,"17":0.1941104048,"18":0.1671272532,"19":0.1184127248,"20":0.1345661097,"21":0.1662621552,"22":0.1687515932,"23":0.1958357655,"24":0.20627913,"25":0.14572305,"26":0.1121963534,"27":0.1000609615,"28":0.1368300564,"29":0.1575238142,"30":0.1258447743,"31":0.1819668544,"32":0.2032309809,"33":0.2130429283,"34":0.2111302554,"35":0.1931955676,"36":0.2193960543,"37":0.1847576574,"38":0.1491056753,"39":0.193322864,"40":0.204277099,"41":0.2288607455,"42":0.2081052421,"43":0.1902602638,"44":0.1936493023,"45":0.1435734428,"46":0.1461515871,"47":0.1326828899,"48":0.1385529075,"49":0.1657677755},"best_lender_clients":{"0":2,"1":2,"2":2,"3":2,"4":2,"5":2,"6":2,"7":2,"8":2,"9":2,"10":2,"11":2,"12":2,"13":2,"14":2,"15":2,"16":2,"17":2,"18":2,"19":2,"20":2,"21":2,"22":2,"23":2,"24":2,"25":2,"26":2,"27":2,"28":2,"29":2,"30":2,"31":2,"32":2,"33":2,"34":2,"35":2,"36":2,"37":2,"38":2,"39":2,"40":2,"41":2,"42":2,"43":2,"44":2,"45":2,"46":2,"47":2,"48":2,"49":2},"rationing":{"0":13.8894014739,"1":0.4704258854,"2":1.7607795821,"3":1.8857640953,"4":1.0455681075,"5":0.0,"6":15.0474486968,"7":8.7007429111,"8":0.0,"9":0.0,"10":0.0,"11":0.0,"12":5.4825740328,"13":3.6506856506,"14":9.1334223591,"15":0.0,"16":0.0,"17":8.2069713151,"18":3.1278948006,"19":0.330581909,"20":0.0,"21":2.9900582719,"22":2.6920874934,"23":0.0,"24":0.0,"25":3.556364357,"26":2.0844614361,"27":0.0,"28":0.0,"29":4.5420222301,"30":0.0,"31":4.6799280149,"32":5.9781929597,"33":1.2678961713,"34":1.229841061,"35":1.0611739973,"36":0.0,"37":0.0,"38":0.0,"39":0.0,"40":4.2223285933,"41":0.0,"42":3.9810603055,"43":0.0,"44":0.0,"45":3.1681114052,"46":1.2366851061,"47":0.0,"48":1.0818867388,"49":7.9055863757},"leverage":{"0":0.0,"1":0.3914828718,"2":0.4050209809,"3":0.0,"4":0.0,"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.1817964091,"10":0.0,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0,"16":0.0,"17":0.0,"18":0.7090918946,"19":0.0,"20":0.0,"21":0.5206569647,"22":0.0,"23":0.0,"24":0.0,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":0.0,"30":0.0,"31":0.0,"32":0.0,"33":0.0,"34":0.0,"35":0.0,"36":0.0,"37":0.0,"38":0.0,"39":0.0,"40":0.0,"41":0.0,"42":0.0,"43":0.0,"44":0.0,"45":0.0,"46":0.0,"47":0.0,"48":0.0,"49":0.0},"systemic_leverage":{"0":0.0,"1":0.0078296574,"2":0.0162008392,"3":0.0,"4":0.0,"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.0036359282,"10":0.0,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0,"16":0.0,"17":0.0,"18":0.0141818379,"19":0.0,"20":0.0,"21":0.0104131393,"22":0.0,"23":0.0,"24":0.0,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":0.0,"30":0.0,"31":0.0,"32":0.0,"33":0.0,"34":0.0,"35":0.0,"36":0.0,"37":0.0,"38":0.0,"39":0.0,"40":0.0,"41":0.0,"42":0.0,"43":0.0,"44":0.0,"45":0.0,"46":0.0,"47":0.0,"48":0.0,"49":0.0},"loans":{"0":null,"1":5.8266226184,"2":6.3824488222,"3":7.4940279608,"4":null,"5":5.824194378,"6":18.091799913,"7":null,"8":14.4450690314,"9":2.6020817861,"10":13.2391416918,"11":null,"12":null,"13":null,"14":null,"15":17.6292121744,"16":null,"17":null,"18":10.487644347,"19":null,"20":null,"21":9.4970015215,"22":null,"23":null,"24":0.7232797011,"25":null,"26":null,"27":null,"28":null,"29":4.5537508276,"30":7.8202476838,"31":null,"32":null,"33":null,"34":14.7761518315,"35":2.2346218974,"36":12.2843304502,"37":2.9486603365,"38":10.7041175286,"39":4.8446133883,"40":15.6555565038,"41":null,"42":null,"43":null,"44":9.9422379218,"45":5.1384435939,"46":13.9408100877,"47":null,"48":14.2718618192,"49":11.3254671116},"reserves":{"0":141.2072219777,"1":151.2830796685,"2":164.4173158921,"3":168.878289899,"4":180.8524541433,"5":177.8240532823,"6":175.9516600006,"7":181.1836205309,"8":187.882800797,"9":200.0914639313,"10":201.4094910101,"11":208.18819141,"12":208.7116707185,"13":218.9215664025,"14":221.0760984858,"15":219.8908809855,"16":224.7703376913,"17":228.2773707014,"18":240.2963721156,"19":235.1411922204,"20":255.4180124577,"21":245.7522000798,"22":252.4601349209,"23":264.3776045075,"24":256.3757966297,"25":273.1583876833,"26":280.5048868984,"27":289.2528542195,"28":283.7234092181,"29":282.4034991275,"30":273.6557633207,"31":291.6547047637,"32":292.6951721751,"33":282.6970468932,"34":277.9879879835,"35":283.4707100131,"36":309.7664113957,"37":300.0155873689,"38":280.0644958025,"39":268.5074779436,"40":284.8394370588,"41":312.5889243871,"42":323.0711124248,"43":322.7875783279,"44":338.0938172557,"45":347.5113695341,"46":359.0963025819,"47":392.4918398942,"48":389.5272040615,"49":410.2065602299},"deposits":{"0":7060.3610988836,"1":7564.1539834253,"2":8220.8657946026,"3":8443.9144949485,"4":9042.6227071632,"5":8891.2026641165,"6":8797.5830000292,"7":9059.1810265431,"8":9394.1400398476,"9":10004.5731965667,"10":10070.4745505031,"11":10409.4095704988,"12":10435.5835359235,"13":10946.0783201268,"14":11053.8049242925,"15":10994.5440492764,"16":11238.5168845627,"17":11413.8685350697,"18":12014.8186057789,"19":11757.0596110189,"20":12770.900622883,"21":12287.6100039898,"22":12623.0067460448,"23":13218.8802253729,"24":12818.7898314851,"25":13657.9193841672,"26":14025.2443449221,"27":14462.6427109732,"28":14186.1704609074,"29":14120.1749563761,"30":13682.7881660363,"31":14582.7352381859,"32":14634.7586087534,"33":14134.8523446609,"34":13899.3993991744,"35":14173.535500654,"36":15488.3205697838,"37":15000.7793684453,"38":14003.2247901258,"39":13425.3738971776,"40":14241.9718529412,"41":15629.4462193529,"42":16153.555621238,"43":16139.3789163965,"44":16904.6908627867,"45":17375.5684767051,"46":17954.8151290958,"47":19624.5919947107,"48":19476.3602030725,"49":20510.3280114971},"active_lenders":{"0":0,"1":1,"2":3,"3":1,"4":0,"5":1,"6":1,"7":0,"8":1,"9":1,"10":2,"11":0,"12":0,"13":0,"14":0,"15":1,"16":0,"17":0,"18":1,"19":0,"20":0,"21":3,"22":0,"23":0,"24":1,"25":0,"26":0,"27":0,"28":0,"29":1,"30":1,"31":0,"32":0,"33":0,"34":1,"35":1,"36":1,"37":1,"38":1,"39":2,"40":1,"41":0,"42":0,"43":0,"44":2,"45":1,"46":2,"47":0,"48":1,"49":1},"active_borrowers":{"0":0,"1":1,"2":3,"3":1,"4":0,"5":1,"6":1,"7":0,"8":1,"9":1,"10":2,"11":0,"12":0,"13":0,"14":0,"15":1,"16":0,"17":0,"18":1,"19":0,"20":0,"21":3,"22":0,"23":0,"24":1,"25":0,"26":0,"27":0,"28":0,"29":1,"30":1,"31":0,"32":0,"33":0,"34":1,"35":1,"36":1,"37":1,"38":1,"39":2,"40":1,"41":0,"42":0,"43":0,"44":2,"45":1,"46":2,"47":0,"48":1,"49":1},"prob_bankruptcy":{"0":0.0,"1":0.0,"2":0.0025896101,"3":0.7583882356,"4":0.0,"5":0.7845652571,"6":0.7812406685,"7":0.0,"8":0.0151044877,"9":0.0151044877,"10":0.0656763575,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0151044877,"16":0.0,"17":0.0,"18":0.0,"19":0.0,"20":0.0,"21":0.5200765667,"22":0.0,"23":0.0,"24":0.7428251216,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":0.6845586799,"30":0.2368952746,"31":0.0,"32":0.0,"33":0.0,"34":0.2368952746,"35":0.5675729548,"36":0.1583689881,"37":0.1390156764,"38":0.0137906834,"39":0.0375675227,"40":0.0137906834,"41":0.0,"42":0.0,"43":0.0,"44":0.0137906834,"45":0.3100743765,"46":0.3100743765,"47":0.0,"48":0.9779198877,"49":0.3100743765},"num_banks":{"0":50,"1":50,"2":50,"3":50,"4":50,"5":50,"6":50,"7":50,"8":50,"9":50,"10":50,"11":50,"12":50,"13":50,"14":50,"15":50,"16":50,"17":50,"18":50,"19":50,"20":50,"21":50,"22":50,"23":50,"24":50,"25":50,"26":50,"27":50,"28":50,"29":50,"30":50,"31":50,"32":50,"33":50,"34":50,"35":50,"36":50,"37":50,"38":50,"39":50,"40":50,"41":50,"42":50,"43":50,"44":50,"45":50,"46":50,"47":50,"48":50,"49":50},"bankruptcy_rationed":{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0}}'

    def setUp(self):
        model = interbank.Model()
        model.config.lender_change = self.ALGORITHM()
        model.log.define_log('ERROR')
        model.config.lender_change.set_parameter("p", self.P)
        model.configure(N=self.N, T=self.T)
        model.initialize(seed=self.SEED)
        model.simulate_full()
        self.generated_now_values = model.finish()
        ## self.results.to_dict() and save the json to self.RESULTS_TO_COMPARE
        ## also        json.dumps(separators=(',', ':'), obj=self.results.to_json())

        # we also create a gdt file with a whole execution:
        model.configure(T=self.T_LONG)
        model.statistics.define_output_format('gdt')
        model.initialize(seed=self.SEED, output_directory='tests',
                         export_datafile='test_whole_execution_restrictedmarket')
        model.simulate_full(interactive=True)
        model.finish()
        os.remove('tests\\test_whole_execution_restrictedmarket_erdos_renyi.json')
        os.remove('tests\\test_whole_execution_restrictedmarket_erdos_renyi.png')

    def test_values_after_execution(self):
        self.assertEqual(self.generated_now_values.to_json(), self.RESULTS_TO_COMPARE)


if __name__ == '__main__':
    unittest.main()
