# -*- coding: utf-8 -*-

import unittest
import interbank
import interbank_lenderchange
import os


class WholeExecution(unittest.TestCase):
    N = 50
    T = 50
    T_LONG = 1000

    maxDiff = None

    ALGORITHM = interbank_lenderchange.RestrictedMarket
    P = 0.5

    SEED = 39393

    RESULTS_TO_COMPARE = '{"bad_debt":{"0":0.0,"1":0.0,"2":7.1798000187,"3":0.0,"4":0.0,"5":4.7708536599,"6":7.6475070752,"7":0.0,"8":14.4450690314,"9":0.0,"10":25.7983155721,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0,"16":16.6812020421,"17":0.0,"18":0.0,"19":0.0,"20":0.0,"21":29.0597339097,"22":4.4056702417,"23":0.0,"24":0.0,"25":0.0,"26":0.0,"27":16.2493851392,"28":0.0,"29":4.5537508276,"30":0.0,"31":0.0,"32":0.0,"33":4.0588260713,"34":0.0,"35":0.0,"36":0.0,"37":2.9486603365,"38":8.6078770967,"39":8.9659470755,"40":30.8698435443,"41":0.0,"42":9.2246651189,"43":0.0,"44":8.1421068768,"45":0.0,"46":27.8816201755,"47":0.0,"48":0.0,"49":11.3254671116},"liquidity":{"0":1727.3499801968,"1":2287.6959315219,"2":2939.6722018504,"3":3218.7641784674,"4":3952.4883637227,"5":3827.417758948,"6":3710.3347772694,"7":4047.0549007397,"8":4370.9973963664,"9":4916.3937884011,"10":5019.7039483347,"11":5425.2511516876,"12":5592.8683864832,"13":6076.2744173709,"14":6231.517465316,"15":6262.011310319,"16":6438.3442225552,"17":6599.3791902016,"18":7073.6551060505,"19":6813.9719940507,"20":7943.240379858,"21":7415.4969776516,"22":7779.7078581691,"23":8381.5396835605,"24":8050.7074799891,"25":8901.15434741,"26":9251.1079822338,"27":9554.8907705171,"28":9407.1097309073,"29":9347.5458461289,"30":8910.659486386,"31":9688.2993966357,"32":9522.7044964058,"33":8988.2379227173,"34":8720.468465223,"35":8717.0092382847,"36":9831.805694149,"37":9541.201513396,"38":8497.5580679051,"39":8017.3655382637,"40":8781.7399441952,"41":10103.7841353223,"42":10639.1878119605,"43":10667.2426810345,"44":11347.7277723332,"45":11772.713418341,"46":12175.153087789,"47":13711.7207015571,"48":13443.0828524542,"49":14447.44740539},"interest_rate":{"0":0.0,"1":0.02,"2":0.02,"3":0.0,"4":0.0,"5":0.0007730754,"6":0.0010912078,"7":0.0,"8":0.0009358195,"9":0.0026395641,"10":0.0122353779,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0036242339,"16":0.02,"17":0.0,"18":0.02,"19":0.0,"20":0.0001476991,"21":2.4787895124,"22":0.02,"23":0.0,"24":0.0,"25":0.0,"26":0.02,"27":0.0,"28":0.0,"29":7.3690663796,"30":0.02,"31":0.0,"32":0.0,"33":0.6810511752,"34":0.02,"35":0.0,"36":0.0139302512,"37":0.02,"38":1.2373448383,"39":0.02,"40":0.2300480931,"41":0.0,"42":2.6507116536,"43":0.0,"44":0.02,"45":0.02,"46":0.0179193556,"47":0.0,"48":0.001768406,"49":0.00983425},"asset_i":{"0":0.0,"1":2.3933413132,"2":2.519285286,"3":2.434138521,"4":2.7180562231,"5":3.1423956663,"6":3.1124384341,"7":2.9047689451,"8":3.1380929619,"9":3.5333556327,"10":2.7017243796,"11":3.8928640032,"12":3.3461606565,"13":3.4940427584,"14":3.0062766006,"15":3.7748304059,"16":3.5907109515,"17":3.9794615784,"18":4.1712430928,"19":3.8966471327,"20":4.4098618708,"21":4.5448207072,"22":3.8292031482,"23":4.6634533537,"24":4.4293867286,"25":5.1188927124,"26":3.6659546995,"27":4.7453917178,"28":4.539998469,"29":4.6302858818,"30":4.0839100789,"31":4.1460101555,"32":4.2262408002,"33":4.2627879911,"34":5.4952246139,"35":4.2856847565,"36":4.8686148805,"37":4.817264385,"38":4.0780600088,"39":3.5579175016,"40":4.6363106009,"41":5.1656300703,"42":4.0312577645,"43":5.2874913751,"44":4.9907060066,"45":5.0269025932,"46":5.2292863359,"47":5.8653141033,"48":5.1213313231,"49":6.4813059757},"asset_j":{"0":0.0,"1":3.9515096095,"2":4.1928244668,"3":4.5459180668,"4":4.7742964536,"5":5.1426073607,"6":5.072570928,"7":5.0225789415,"8":5.1934006545,"9":5.3744381956,"10":5.5403883821,"11":5.7291914443,"12":5.9004967067,"13":5.9992350778,"14":6.1955905545,"15":6.3056416436,"16":6.2574572199,"17":6.4130507481,"18":6.4905015699,"19":6.6758296512,"20":6.6344246895,"21":7.1969592255,"22":6.8592003218,"23":7.1325500096,"24":7.428626425,"25":7.293829745,"26":7.6913005244,"27":7.8254844888,"28":8.0352060353,"29":7.9669374523,"30":7.8991034921,"31":7.6364424456,"32":8.0871022458,"33":8.0023974244,"34":7.7709521591,"35":7.5203439038,"36":7.6172711303,"37":8.1133437348,"38":7.9491234199,"39":7.4633578046,"40":7.2650472087,"41":7.6625272834,"42":8.2748679869,"43":8.5733378207,"44":8.5788955559,"45":8.9240726329,"46":9.091145578,"47":9.3627705488,"48":10.1128424869,"49":9.9435683481},"equity":{"0":725.1922954844,"1":701.3252383038,"2":676.935054678,"3":645.6635139954,"4":665.5352959591,"5":676.3965697462,"6":660.7983162201,"7":664.8337774376,"8":664.2686852816,"9":662.4612092497,"10":647.6993808249,"11":652.839895424,"12":634.2177113948,"13":674.0744225087,"14":673.5488672387,"15":664.824792279,"16":680.7136215812,"17":676.4233271696,"18":656.9458213102,"19":653.0588109181,"20":641.324069227,"21":617.4040650311,"22":629.7476619042,"23":621.0093849539,"24":619.6124332402,"25":583.8400120902,"26":604.4572152717,"27":593.8316420701,"28":583.587566731,"29":600.2344036768,"30":590.4315486662,"31":590.4315486662,"32":593.4500830532,"33":610.0303417052,"34":624.2265706108,"35":609.7585859298,"36":603.2007245045,"37":583.6737856749,"38":593.4868560055,"39":590.1165403326,"40":596.8942212411,"41":590.6121651082,"42":621.4721495088,"43":613.7507009325,"44":618.988328803,"45":601.5470038792,"46":619.2135892689,"47":612.5039048207,"48":619.6782551498,"49":622.6898773814},"equity_borrowers":{"0":0.0,"1":0.0,"2":0.0,"3":0.0,"4":0.0,"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.0,"10":0.0,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0,"16":0.0,"17":0.0,"18":0.0,"19":0.0,"20":15.0,"21":0.0,"22":0.0,"23":0.0,"24":0.0,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":0.0,"30":0.0,"31":0.0,"32":0.0,"33":0.0,"34":0.0,"35":0.0,"36":0.0,"37":0.0,"38":0.0,"39":0.0,"40":0.0,"41":0.0,"42":0.0,"43":0.0,"44":0.0,"45":0.0,"46":0.0,"47":0.0,"48":0.0,"49":0.0},"bankruptcies":{"0":6,"1":10,"2":8,"3":3,"4":8,"5":8,"6":10,"7":8,"8":5,"9":2,"10":4,"11":6,"12":6,"13":8,"14":6,"15":2,"16":4,"17":3,"18":2,"19":6,"20":3,"21":3,"22":3,"23":3,"24":5,"25":3,"26":4,"27":3,"28":2,"29":5,"30":0,"31":1,"32":2,"33":3,"34":2,"35":2,"36":1,"37":3,"38":2,"39":7,"40":7,"41":3,"42":4,"43":1,"44":4,"45":2,"46":6,"47":4,"48":2,"49":5},"potential_credit_channels":{"0":20,"1":20,"2":20,"3":20,"4":20,"5":20,"6":20,"7":20,"8":20,"9":20,"10":20,"11":20,"12":20,"13":20,"14":20,"15":20,"16":20,"17":20,"18":20,"19":20,"20":20,"21":20,"22":20,"23":20,"24":20,"25":20,"26":20,"27":20,"28":20,"29":20,"30":20,"31":20,"32":20,"33":20,"34":20,"35":20,"36":20,"37":20,"38":20,"39":20,"40":20,"41":20,"42":20,"43":20,"44":20,"45":20,"46":20,"47":20,"48":20,"49":20},"prob_change_lender":{"0":0.0,"1":0.0,"2":0.0,"3":0.0,"4":0.0,"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.0,"10":0.0,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0,"16":0.0,"17":0.0,"18":0.0,"19":0.0,"20":0.0,"21":0.0,"22":0.0,"23":0.0,"24":0.0,"25":0.0,"26":0.0,"27":0.0,"28":0.0,"29":0.0,"30":0.0,"31":0.0,"32":0.0,"33":0.0,"34":0.0,"35":0.0,"36":0.0,"37":0.0,"38":0.0,"39":0.0,"40":0.0,"41":0.0,"42":0.0,"43":0.0,"44":0.0,"45":0.0,"46":0.0,"47":0.0,"48":0.0,"49":0.0},"best_lender":{"0":7,"1":7,"2":7,"3":7,"4":7,"5":7,"6":7,"7":7,"8":7,"9":7,"10":7,"11":7,"12":7,"13":7,"14":7,"15":7,"16":7,"17":7,"18":7,"19":7,"20":7,"21":7,"22":7,"23":7,"24":7,"25":7,"26":7,"27":7,"28":7,"29":7,"30":7,"31":7,"32":7,"33":7,"34":7,"35":7,"36":7,"37":7,"38":7,"39":7,"40":7,"41":7,"42":7,"43":7,"44":7,"45":7,"46":7,"47":7,"48":7,"49":7},"policy":{"0":1.0,"1":1.0,"2":1.0,"3":1.0,"4":1.0,"5":1.0,"6":1.0,"7":1.0,"8":1.0,"9":1.0,"10":1.0,"11":1.0,"12":1.0,"13":1.0,"14":1.0,"15":1.0,"16":1.0,"17":1.0,"18":1.0,"19":1.0,"20":1.0,"21":1.0,"22":1.0,"23":1.0,"24":1.0,"25":1.0,"26":1.0,"27":1.0,"28":1.0,"29":1.0,"30":1.0,"31":1.0,"32":1.0,"33":1.0,"34":1.0,"35":1.0,"36":1.0,"37":1.0,"38":1.0,"39":1.0,"40":1.0,"41":1.0,"42":1.0,"43":1.0,"44":1.0,"45":1.0,"46":1.0,"47":1.0,"48":1.0,"49":1.0},"fitness":{"0":0.0,"1":0.2900121673,"2":0.2358271425,"3":0.2130061235,"4":0.167029992,"5":0.1212196936,"6":0.1171868413,"7":0.1363052306,"8":0.0894308408,"9":0.0858057176,"10":0.07448818,"11":0.0843328178,"12":0.076276303,"13":0.0814323427,"14":0.1026376484,"15":0.0984047473,"16":0.2003538689,"17":0.205609546,"18":0.1762433613,"19":0.1204900798,"20":0.1379854409,"21":0.1715171065,"22":0.1714739356,"23":0.2013292913,"24":0.2110435524,"25":0.1519358471,"26":0.1154177808,"27":0.1021662934,"28":0.1397194069,"29":0.1627226556,"30":0.1328910149,"31":0.1900537313,"32":0.2087470965,"33":0.2135615476,"34":0.2122638523,"35":0.194864069,"36":0.2145157995,"37":0.1768604771,"38":0.143209593,"39":0.1852422277,"40":0.1895066459,"41":0.2205800746,"42":0.2005462017,"43":0.2211678762,"44":0.1987231419,"45":0.1384087255,"46":0.1395808472,"47":0.1501683598,"48":0.1578316866,"49":0.2220276328},"best_lender_clients":{"0":2,"1":2,"2":2,"3":2,"4":2,"5":2,"6":2,"7":2,"8":2,"9":2,"10":2,"11":2,"12":2,"13":2,"14":2,"15":2,"16":2,"17":2,"18":2,"19":2,"20":2,"21":2,"22":2,"23":2,"24":2,"25":2,"26":2,"27":2,"28":2,"29":2,"30":2,"31":2,"32":2,"33":2,"34":2,"35":2,"36":2,"37":2,"38":2,"39":2,"40":2,"41":2,"42":2,"43":2,"44":2,"45":2,"46":2,"47":2,"48":2,"49":2},"rationing":{"0":5.4323969384,"1":0.4704258854,"2":6.9649139239,"3":1.8857640953,"4":1.0455681075,"5":0.0,"6":4.7214498201,"7":0.0,"8":0.0,"9":0.4334968475,"10":0.0,"11":0.6766713143,"12":0.0,"13":3.6506856506,"14":3.4183176903,"15":0.0,"16":0.0,"17":1.2324677871,"18":0.0,"19":0.330581909,"20":0.0,"21":7.1336198829,"22":0.0,"23":0.0,"24":0.0,"25":3.556364357,"26":0.0,"27":4.4826255554,"28":0.0,"29":4.7376693192,"30":0.0,"31":0.0,"32":5.9781929597,"33":1.2678961713,"34":0.0,"35":1.0611739973,"36":0.0,"37":0.0223905025,"38":0.0,"39":0.0,"40":4.2223285933,"41":2.2992640785,"42":3.9810603055,"43":3.1469626618,"44":0.0,"45":1.5332263095,"46":0.0,"47":0.0,"48":0.0,"49":0.0},"leverage":{"0":0.0,"1":0.3914828718,"2":0.4050209809,"3":0.0,"4":0.0,"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.1735515867,"10":0.0,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":3.7118088526,"16":0.0,"17":0.0,"18":0.7090918946,"19":0.0,"20":0.0,"21":0.3375204767,"22":0.0,"23":0.0,"24":0.0,"25":0.0,"26":1.1072825569,"27":0.0,"28":0.0,"29":0.0,"30":1.0375008588,"31":0.0,"32":0.0,"33":0.0,"34":1.0048743569,"35":0.0,"36":1.2969425762,"37":1.1608033092,"38":0.0,"39":0.0,"40":0.0,"41":0.0,"42":0.0,"43":0.0,"44":0.0,"45":0.3449260839,"46":0.0,"47":0.0,"48":0.15068226,"49":0.0},"systemic_leverage":{"0":0.0,"1":0.0078296574,"2":0.0162008392,"3":0.0,"4":0.0,"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.0034710317,"10":0.0,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0742361771,"16":0.0,"17":0.0,"18":0.0141818379,"19":0.0,"20":0.0,"21":0.0135008191,"22":0.0,"23":0.0,"24":0.0,"25":0.0,"26":0.0221456511,"27":0.0,"28":0.0,"29":0.0,"30":0.0207500172,"31":0.0,"32":0.0,"33":0.0,"34":0.0200974871,"35":0.0,"36":0.0259388515,"37":0.0232160662,"38":0.0,"39":0.0,"40":0.0,"41":0.0,"42":0.0,"43":0.0,"44":0.0,"45":0.0068985217,"46":0.0,"47":0.0,"48":0.0030136452,"49":0.0},"loans":{"0":null,"1":5.8266226184,"2":6.3824488222,"3":null,"4":null,"5":4.7708536599,"6":7.6475070752,"7":null,"8":14.4450690314,"9":2.6020817861,"10":12.8991577861,"11":null,"12":null,"13":null,"14":null,"15":17.6292121744,"16":16.6812020421,"17":null,"18":10.487644347,"19":null,"20":16.5459641339,"21":9.7010485236,"22":4.4056702417,"23":null,"24":null,"25":null,"26":16.2493851392,"27":null,"28":null,"29":4.5537508276,"30":7.8202476838,"31":null,"32":null,"33":4.0588260713,"34":14.7761518315,"35":null,"36":12.2843304502,"37":6.8470232768,"38":8.6078770967,"39":4.4829735377,"40":15.4349217721,"41":null,"42":9.2246651189,"43":null,"44":8.1421068768,"45":5.1384435939,"46":13.9408100877,"47":null,"48":2.2596317816,"49":11.3254671116},"reserves":{"0":142.054084939,"1":151.9932634304,"2":165.3081717437,"3":169.2777616411,"4":184.269073006,"5":181.1463876633,"6":179.2615207644,"7":185.5001648728,"8":192.5381355517,"9":203.6599674609,"10":205.8216789373,"11":213.0138122503,"12":215.9732110889,"13":227.0671569156,"14":230.2673768379,"15":230.419242962,"16":234.4867032141,"17":237.7479787215,"18":246.9558326881,"19":241.4344946747,"20":263.7420946431,"21":252.8177491832,"22":260.3121748402,"23":271.821117475,"24":265.1566212873,"25":280.835278241,"26":289.1946363409,"27":295.2961705251,"28":291.4930998642,"29":291.5167954518,"30":282.491076276,"31":298.361278526,"32":294.6467827038,"33":283.879665634,"34":278.6113397437,"35":277.7647799958,"36":300.2732422094,"37":293.4333658729,"38":271.6545267932,"39":262.8732949919,"40":278.89594389,"41":305.8184620021,"42":317.624959611,"43":318.1332842316,"44":332.8138985855,"45":340.8956739098,"46":348.0032723981,"47":378.8881962981,"48":373.4458702708,"49":394.9754336578},"deposits":{"0":7102.7042469491,"1":7599.663171519,"2":8265.4085871846,"3":8463.8880820559,"4":9213.4536503018,"5":9057.3193831669,"6":8963.0760382196,"7":9275.0082436388,"8":9626.9067775868,"9":10182.9983730449,"10":10291.0839468626,"11":10650.690612513,"12":10798.6605544454,"13":11353.357845779,"14":11513.3688418942,"15":11520.9621480976,"16":11724.3351607059,"17":11887.3989360725,"18":12347.791634407,"19":12071.7247337333,"20":13187.1047321571,"21":12640.8874591595,"22":13015.6087420123,"23":13591.0558737515,"24":13257.8310643658,"25":14041.7639120483,"26":14459.7318170466,"27":14764.8085262559,"28":14574.6549932103,"29":14575.8397725886,"30":14124.5538138013,"31":14918.063926301,"32":14732.3391351923,"33":14193.9832817011,"34":13930.5669871854,"35":13888.2389997911,"36":15013.6621104714,"37":14671.6682936443,"38":13582.7263396578,"39":13143.664749596,"40":13944.7971945024,"41":15290.9231001058,"42":15881.2479805476,"43":15906.6642115804,"44":16640.6949292763,"45":17044.7836954902,"46":17400.1636199037,"47":18944.4098149061,"48":18672.2935135399,"49":19748.7716828888},"active_lenders":{"0":0,"1":1,"2":3,"3":0,"4":0,"5":1,"6":1,"7":0,"8":1,"9":1,"10":2,"11":0,"12":0,"13":0,"14":0,"15":1,"16":1,"17":0,"18":1,"19":0,"20":1,"21":4,"22":1,"23":0,"24":0,"25":0,"26":1,"27":0,"28":0,"29":1,"30":1,"31":0,"32":0,"33":1,"34":1,"35":0,"36":1,"37":2,"38":1,"39":2,"40":2,"41":0,"42":1,"43":0,"44":1,"45":1,"46":2,"47":0,"48":1,"49":1},"active_borrowers":{"0":0,"1":1,"2":3,"3":0,"4":0,"5":1,"6":1,"7":0,"8":1,"9":1,"10":2,"11":0,"12":0,"13":0,"14":0,"15":1,"16":1,"17":0,"18":1,"19":0,"20":1,"21":4,"22":1,"23":0,"24":0,"25":0,"26":1,"27":0,"28":0,"29":1,"30":1,"31":0,"32":0,"33":1,"34":1,"35":0,"36":1,"37":2,"38":1,"39":2,"40":2,"41":0,"42":1,"43":0,"44":1,"45":1,"46":2,"47":0,"48":1,"49":1},"prob_bankruptcy":{"0":0.0,"1":0.0,"2":0.0025896101,"3":0.0,"4":0.0,"5":0.0151044877,"6":0.0151044877,"7":0.0,"8":0.0151044877,"9":0.0151044877,"10":0.015329975,"11":0.0,"12":0.0,"13":0.0,"14":0.0,"15":0.0151044877,"16":0.688149675,"17":0.0,"18":0.0,"19":0.0,"20":1.5020528224,"21":0.2423937985,"22":0.0804276273,"23":0.0,"24":0.0,"25":0.0,"26":0.0052674847,"27":0.0,"28":0.0,"29":0.9125422422,"30":0.0,"31":0.0,"32":0.0,"33":0.4974945407,"34":0.0,"35":0.0,"36":0.0349659694,"37":0.1842746246,"38":0.6347214879,"39":0.0,"40":0.1914382155,"41":0.0,"42":0.7943119176,"43":0.0,"44":0.0,"45":0.0,"46":0.0068046378,"47":0.0,"48":0.0068046378,"49":0.0068046378},"num_banks":{"0":50,"1":50,"2":50,"3":50,"4":50,"5":50,"6":50,"7":50,"8":50,"9":50,"10":50,"11":50,"12":50,"13":50,"14":50,"15":50,"16":50,"17":50,"18":50,"19":50,"20":50,"21":50,"22":50,"23":50,"24":50,"25":50,"26":50,"27":50,"28":50,"29":50,"30":50,"31":50,"32":50,"33":50,"34":50,"35":50,"36":50,"37":50,"38":50,"39":50,"40":50,"41":50,"42":50,"43":50,"44":50,"45":50,"46":50,"47":50,"48":50,"49":50},"bankruptcy_rationed":{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0}}'

    def setUp(self):
        model = interbank.Model()
        model.config.lender_change = self.ALGORITHM()
        model.log.define_log('ERROR')
        model.config.lender_change.set_parameter("p", self.P)
        model.configure(N=self.N, T=self.T)
        model.initialize(seed=self.SEED, output_directory='tests',
                         export_datafile='test_whole_execution_restrictedmarket')
        model.simulate_full()
        self.generated_now_values = model.finish()
        os.remove('tests\\test_whole_execution_restrictedmarket_erdos_renyi.json')
        os.remove('tests\\test_whole_execution_restrictedmarket_erdos_renyi.png')


    def test_values_after_execution(self):
        self.assertEqual(self.generated_now_values.to_json(), self.RESULTS_TO_COMPARE)


if __name__ == '__main__':
    unittest.main()
